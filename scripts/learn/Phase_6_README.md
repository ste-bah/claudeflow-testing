README — Phase 6 Knowledge Promotion (god-learn/)

Summary



Phase 6 implements the Option B → Option A convergence layer: it promotes high-signal, citation-locked, extractive knowledge units from retrieval-time results into a durable store under:



god-learn/knowledge.jsonl (append-only knowledge units)



god-learn/index.json (id → byte offset index for idempotent promotion)



This phase is deterministic, restart-safe, and auditable, and it does not modify:



ingestion



embeddings



chunk boundaries



manifest



Promotion is performed strictly from existing retrieval outputs (Phase 4/5), and every unit remains grounded in:



chunk\_id



path\_rel



page\_start/page\_end (stored as pages)



Environment Assumptions (Locked)



Repo: claudeflow-testing



Corpus root: /home/dalton/projects/claudeflow-testing/corpus



Chroma persistent DB: /home/dalton/projects/claudeflow-testing/vector\_db\_1536



Chroma collection: knowledge\_chunks



Local embedding server: http://127.0.0.1:8000/embed (used only by retrieval)



WSL Ubuntu, Python 3.11+



What Was Added (Phase 6 Deliverables)

New scripts



scripts/learn/promote\_hits.py

Promotes retrieval JSON → god-learn/knowledge.jsonl (+ index.json)



scripts/learn/verify\_knowledge.py

Verifies knowledge units are valid and grounded in Chroma + page ranges



New directory



god-learn/



knowledge.jsonl (append-only)



index.json (id → offset)



Inputs and Outputs

Input: retrieval hits JSON



Generated by Phase 4/5 retrieval with docs included:



/tmp/phase4\_hits.json



This file must contain:



results\[].chunk\_id



results\[].path\_rel



results\[].page\_start



results\[].page\_end



results\[].text ✅ required for extractive promotion



(optional) results\[].meta (present in current pipeline)



Output: knowledge units JSONL



god-learn/knowledge.jsonl



Each line is a knowledge unit:



{

&nbsp; "id": "ku\_00ddb2542e3d3dfa",

&nbsp; "claim": "Extractive sentence from chunk text...",

&nbsp; "sources": \[

&nbsp;   {

&nbsp;     "author": "...",

&nbsp;     "title": "...",

&nbsp;     "path\_rel": "rhetorical\_ontology/...",

&nbsp;     "pages": "19–20",

&nbsp;     "chunk\_id": "docid:00023"

&nbsp;   }

&nbsp; ],

&nbsp; "confidence": "high",

&nbsp; "tags": \[],

&nbsp; "created\_from\_query": "phantasia and action",

&nbsp; "debug": { "...": "..." }

}



Index



god-learn/index.json maps id → byte\_offset into knowledge.jsonl to ensure:



idempotent reruns



fast “already promoted” checks



How Promotion Works (Deterministic)



Retrieve top-K chunks (Phase 4/5) with --include\_docs to include chunk text.



For each chunk:



split text into sentences



select the “best” sentence deterministically by query keyword overlap



Construct a unit:



claim = literal extracted sentence (no paraphrase)



sources = chunk metadata (chunk\_id, path\_rel, pages)



Create stable ID:



id = "ku\_" + sha256({claim + sorted(sources)})\[:16]



Append to god-learn/knowledge.jsonl only if not already present in index.json.



Commands to Run Phase 6 (Copy/Paste)

0\) Go to repo root

cd /home/dalton/projects/claudeflow-testing



1\) Generate retrieval hits JSON (include docs + highlights)

python3 scripts/retrieval/query\_chunks.py \\

&nbsp; "phantasia and action" \\

&nbsp; --k 30 \\

&nbsp; --overfetch 60 \\

&nbsp; --use\_highlights \\

&nbsp; --include\_docs \\

&nbsp; --print\_json \\

&nbsp; --chroma\_dir /home/dalton/projects/claudeflow-testing/vector\_db\_1536 \\

&nbsp; --collection knowledge\_chunks \\

&nbsp; > /tmp/phase4\_hits.json





Sanity check JSON:



python3 -m json.tool /tmp/phase4\_hits.json >/dev/null \&\& echo "HITS\_JSON\_OK"



2\) Dry-run promotion (preview units)

python3 scripts/learn/promote\_hits.py \\

&nbsp; --hits\_json /tmp/phase4\_hits.json \\

&nbsp; --query "phantasia and action" \\

&nbsp; --dry\_run \\

&nbsp; > /tmp/phase6\_units\_preview.json





Inspect preview:



python3 - <<'PY'

import json

d=json.load(open("/tmp/phase6\_units\_preview.json"))

print("units:", len(d))

if d:

&nbsp;   u=d\[0]

&nbsp;   print("id:", u\["id"])

&nbsp;   print("claim:", u\["claim"])

&nbsp;   print("source:", u\["sources"]\[0])

PY



3\) Promote for real (writes to god-learn/)

python3 scripts/learn/promote\_hits.py \\

&nbsp; --hits\_json /tmp/phase4\_hits.json \\

&nbsp; --query "phantasia and action"





Confirm outputs:



ls -lah god-learn

wc -l god-learn/knowledge.jsonl

python3 -c "import json; print('index entries:', len(json.load(open('god-learn/index.json'))))"



4\) Verify promoted knowledge units

python3 scripts/learn/verify\_knowledge.py --strict\_order

echo $?





Expected:



\[Phase6:verify] OK units=<N>



exit code 0



5\) Prove idempotency (rerun promotion)

python3 scripts/learn/promote\_hits.py \\

&nbsp; --hits\_json /tmp/phase4\_hits.json \\

&nbsp; --query "phantasia and action"





Expected:



promoted=0 (no duplicates created)



Optional duplicate check:



python3 - <<'PY'

import json

ids=\[]

for line in open("god-learn/knowledge.jsonl", encoding="utf-8"):

&nbsp;   if line.strip():

&nbsp;       ids.append(json.loads(line)\["id"])

print("rows:", len(ids))

print("unique:", len(set(ids)))

print("dupes:", len(ids)-len(set(ids)))

PY



6\) Regression checks (Phases 1–5)



Phase 2 integrity (Chroma + manifest):



python3 scripts/ingest/verify\_ingest.py \\

&nbsp; --root /home/dalton/projects/claudeflow-testing/corpus \\

&nbsp; --manifest /home/dalton/projects/claudeflow-testing/scripts/ingest/manifest.jsonl \\

&nbsp; --chroma\_dir /home/dalton/projects/claudeflow-testing/vector\_db\_1536 \\

&nbsp; --collection knowledge\_chunks

echo $?





Phase 5 highlight rerank verification:



./scripts/highlights/phase5check.sh

echo $?



7\) One-line end-to-end proof command

python3 scripts/learn/verify\_knowledge.py --strict\_order \&\& \\

python3 scripts/ingest/verify\_ingest.py \\

&nbsp; --root /home/dalton/projects/claudeflow-testing/corpus \\

&nbsp; --manifest /home/dalton/projects/claudeflow-testing/scripts/ingest/manifest.jsonl \\

&nbsp; --chroma\_dir /home/dalton/projects/claudeflow-testing/vector\_db\_1536 \\

&nbsp; --collection knowledge\_chunks \&\& \\

./scripts/highlights/phase5check.sh



Notes / Known Behaviors



If you run promote\_hits.py --dry\_run after promotion, it may output \[].

This is correct: all units already exist in index.json, so nothing new would be promoted.



synthesize\_cited.py outputs Markdown intended for human inspection; Phase 6 promotion is performed from phase4\_hits.json directly for strict determinism and schema control.



Phase 6 Completion Criteria (Met)



Phase 6 is complete when:



god-learn/knowledge.jsonl exists and contains promoted units



scripts/learn/verify\_knowledge.py --strict\_order exits 0



scripts/ingest/verify\_ingest.py ... exits 0



scripts/highlights/phase5check.sh exits 0



promotion is idempotent (promoted=0 on rerun)

