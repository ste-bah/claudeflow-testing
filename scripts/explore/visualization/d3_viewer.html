<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 11 - Interactive Knowledge Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            overflow: hidden;
        }

        #header {
            background: #2196F3;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            margin: 0;
            font-size: 24px;
        }

        #controls {
            padding: 10px 20px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #controls label {
            font-weight: bold;
        }

        #controls input[type="file"] {
            padding: 5px 10px;
        }

        #controls button {
            padding: 8px 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #controls button:hover {
            background: #1976D2;
        }

        #graph-container {
            position: relative;
            width: 100vw;
            height: calc(100vh - 150px);
        }

        #info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        #info-panel h3 {
            margin-top: 0;
            color: #2196F3;
        }

        #info-panel .close-btn {
            float: right;
            cursor: pointer;
            font-size: 20px;
            color: #999;
        }

        #info-panel .close-btn:hover {
            color: #333;
        }

        .node {
            cursor: pointer;
            stroke-width: 2px;
        }

        .node.ku {
            fill: #2196F3;
            stroke: #1976D2;
        }

        .node.reasoning {
            fill: #FF9800;
            stroke: #F57C00;
        }

        .node.document {
            fill: #4CAF50;
            stroke: #388E3C;
        }

        .node.query {
            fill: #F44336;
            stroke: #D32F2F;
        }

        .node:hover {
            stroke-width: 4px;
            filter: brightness(1.2);
        }

        .link {
            stroke-width: 2px;
            stroke-opacity: 0.6;
        }

        .link.conflict {
            stroke: #F44336;
        }

        .link.support {
            stroke: #4CAF50;
        }

        .link.elaboration {
            stroke: #2196F3;
        }

        .link.contrast {
            stroke: #FF9800;
        }

        .link.cites {
            stroke: #9C27B0;
        }

        .link.created {
            stroke: #FFC107;
        }

        .node-label {
            font-size: 10px;
            fill: #333;
            text-anchor: middle;
            pointer-events: none;
        }

        #legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #legend h4 {
            margin-top: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }

        #stats {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #stats h4 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ðŸ“Š Phase 11 - Interactive Knowledge Graph</h1>
    </div>

    <div id="controls">
        <label for="file-input">Load Graph:</label>
        <input type="file" id="file-input" accept=".json">

        <button id="reset-btn">Reset View</button>
        <button id="toggle-labels-btn">Toggle Labels</button>

        <span id="file-status"></span>
    </div>

    <div id="graph-container">
        <svg id="graph"></svg>

        <div id="stats">
            <h4>Graph Statistics</h4>
            <div id="stats-content">Load a graph file to see statistics</div>
        </div>

        <div id="legend">
            <h4>Legend</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #2196F3;"></div>
                <span>Knowledge Unit (KU)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF9800;"></div>
                <span>Reasoning Unit (RU)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4CAF50;"></div>
                <span>Document</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F44336;"></div>
                <span>Query</span>
            </div>
        </div>

        <div id="info-panel">
            <span class="close-btn">&times;</span>
            <div id="info-content"></div>
        </div>
    </div>

    <script>
        // Graph configuration
        const width = window.innerWidth;
        const height = window.innerHeight - 150;

        let svg = d3.select("#graph")
            .attr("width", width)
            .attr("height", height);

        let g = svg.append("g");

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 10])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // State
        let simulation;
        let showLabels = true;
        let currentData = null;

        // File input handler
        document.getElementById("file-input").addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        loadGraph(data);
                        document.getElementById("file-status").textContent = `Loaded: ${file.name}`;
                    } catch (error) {
                        alert("Error loading file: " + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Control button handlers
        document.getElementById("reset-btn").addEventListener("click", resetView);
        document.getElementById("toggle-labels-btn").addEventListener("click", toggleLabels);
        document.querySelector("#info-panel .close-btn").addEventListener("click", () => {
            document.getElementById("info-panel").style.display = "none";
        });

        function loadGraph(data) {
            currentData = data;

            // Update stats
            updateStats(data);

            // Clear existing graph
            g.selectAll("*").remove();

            // Stop existing simulation
            if (simulation) {
                simulation.stop();
            }

            // Create simulation
            simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links)
                    .id(d => d.id)
                    .distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(30));

            // Create links
            const link = g.append("g")
                .selectAll("line")
                .data(data.links)
                .enter()
                .append("line")
                .attr("class", d => `link ${d.relation}`)
                .attr("marker-end", "url(#arrow)");

            // Create arrow marker
            svg.append("defs").append("marker")
                .attr("id", "arrow")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 20)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", "#999");

            // Create nodes
            const node = g.append("g")
                .selectAll("circle")
                .data(data.nodes)
                .enter()
                .append("circle")
                .attr("class", d => `node ${d.type}`)
                .attr("r", 10)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .on("click", showNodeInfo);

            // Add labels
            const labels = g.append("g")
                .selectAll("text")
                .data(data.nodes)
                .enter()
                .append("text")
                .attr("class", "node-label")
                .text(d => d.label.substring(0, 30) + (d.label.length > 30 ? "..." : ""))
                .attr("dy", 25)
                .style("display", showLabels ? "block" : "none");

            // Update positions on tick
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                labels
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });
        }

        function updateStats(data) {
            const nodeTypes = {};
            data.nodes.forEach(n => {
                nodeTypes[n.type] = (nodeTypes[n.type] || 0) + 1;
            });

            const edgeTypes = {};
            data.links.forEach(l => {
                edgeTypes[l.relation] = (edgeTypes[l.relation] || 0) + 1;
            });

            let html = `
                <strong>Nodes:</strong> ${data.nodes.length}<br>
                ${Object.entries(nodeTypes).map(([type, count]) =>
                    `&nbsp;&nbsp;${type}: ${count}`).join("<br>")}
                <br><br>
                <strong>Edges:</strong> ${data.links.length}<br>
                ${Object.entries(edgeTypes).map(([type, count]) =>
                    `&nbsp;&nbsp;${type}: ${count}`).join("<br>")}
            `;

            document.getElementById("stats-content").innerHTML = html;
        }

        function showNodeInfo(event, d) {
            const panel = document.getElementById("info-panel");
            const content = document.getElementById("info-content");

            let html = `
                <h3>${d.type.toUpperCase()}: ${d.id}</h3>
                <p><strong>Label:</strong> ${d.label}</p>
            `;

            if (d.attributes) {
                html += "<h4>Attributes:</h4><ul>";
                for (const [key, value] of Object.entries(d.attributes)) {
                    if (typeof value === "string" && value.length > 200) {
                        html += `<li><strong>${key}:</strong> ${value.substring(0, 200)}...</li>`;
                    } else {
                        html += `<li><strong>${key}:</strong> ${JSON.stringify(value)}</li>`;
                    }
                }
                html += "</ul>";
            }

            content.innerHTML = html;
            panel.style.display = "block";
        }

        function resetView() {
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
        }

        function toggleLabels() {
            showLabels = !showLabels;
            d3.selectAll(".node-label").style("display", showLabels ? "block" : "none");
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Instructions on load
        window.addEventListener("load", () => {
            document.getElementById("stats-content").innerHTML = `
                <strong>Instructions:</strong><br>
                1. Generate a D3 graph:<br>
                &nbsp;&nbsp;<code>god-explore graph --format d3 --output graph.json</code><br>
                2. Load the JSON file above<br>
                3. Drag nodes to rearrange<br>
                4. Zoom with mouse wheel<br>
                5. Click nodes for details
            `;
        });
    </script>
</body>
</html>
