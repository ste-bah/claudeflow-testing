#!/usr/bin/env node
/**
 * PhD Pipeline CLI - Guided orchestration tool
 * Implements REQ-PIPE-001 through REQ-PIPE-007
 */
import type { StoredStyleProfile } from '../universal/style-profile.js';
import type { InitOptions, InitResponse, NextOptions, NextResponse, CompleteOptions, CompleteResponse, StatusOptions, StatusResponse, ListOptions, ListResponse, ResumeOptions, ResumeResponse, AbortOptions, AbortResponse } from './cli-types.js';
import { type AgentConfig as PhdAgentConfig, type PhaseDefinition } from './phd-pipeline-config.js';
import type { FinalStageResult } from './final-stage/index.js';
/**
 * Expected total agent count from phd-pipeline-config.ts
 * Used for validation and progress calculations
 * IMPORTANT: This is 46 agents (not 43 from the old incorrect mapping)
 */
declare const PHD_PIPELINE_AGENT_COUNT: number;
/**
 * Result of agent file validation.
 * Contains detailed information about which agent files exist and which are missing.
 */
export interface AgentValidationResult {
    /** Whether all agent files passed validation */
    valid: boolean;
    /** Total number of agents in PHD_AGENTS configuration */
    totalAgents: number;
    /** Number of agent files found on disk */
    foundAgents: number;
    /** Agent keys whose .md files are missing */
    missingAgents: string[];
    /** Agent keys whose .md files exist but are empty or malformed */
    invalidAgents: string[];
    /** Directory where agent files are expected */
    agentsDirectory: string;
    /** Detailed error messages for each issue */
    errors: string[];
}
/**
 * Validate that all 46 agent .md files exist in the agents directory.
 * Implements RULE-018: Agent Key Validity - all agent keys must have corresponding .md files.
 *
 * @returns Promise<AgentValidationResult> - Detailed validation results
 *
 * Validation checks:
 * 1. Each agent in PHD_AGENTS has a corresponding .md file at ${DEFAULT_CONFIG.agentsDirectory}/${agent.file}
 * 2. Each .md file is non-empty (at least 100 bytes - reasonable minimum for agent definition)
 * 3. Each .md file contains valid content (starts with # or ---)
 *
 * @example
 * const result = await validateAgentFiles();
 * if (!result.valid) {
 *   console.error('Missing agents:', result.missingAgents);
 *   process.exit(1);
 * }
 */
declare function validateAgentFiles(): Promise<AgentValidationResult>;
/**
 * Result of building an agent prompt with the 5-part template.
 * Contains the complete prompt along with metadata for tracing.
 */
export interface PromptBuildResult {
    /** The complete 5-part prompt string */
    prompt: string;
    /** Agent key (e.g., 'self-ask-decomposer') */
    agentKey: string;
    /** Human-readable agent name */
    agentDisplayName: string;
    /** Phase number (1-7) */
    phase: number;
    /** Memory keys to retrieve from previous agents */
    memoryRetrievalKeys: string[];
    /** Memory key to store this agent's output */
    memoryStorageKey: string;
    /** Word count of the generated prompt */
    wordCount: number;
}
/**
 * Result of getting the next agent in the pipeline.
 * Contains complete agent configuration, generated prompt, and metadata.
 *
 * This is the canonical return type for getNextAgent() and provides
 * all information needed to execute the next agent step.
 */
export interface NextAgentResult {
    /** Agent configuration from PHD_AGENTS */
    agent: PhdAgentConfig;
    /** Complete 5-part prompt generated by buildAgentPrompt() */
    prompt: string;
    /** 0-based index of this agent in the pipeline (0-45 for 46 agents) */
    agentIndex: number;
    /** Total number of agents in the pipeline (46 for standard, may vary with dynamic Phase 6) */
    totalAgents: number;
    /** Phase definition for this agent's phase */
    phase: PhaseDefinition;
    /** True if this is the last agent in the pipeline */
    isLastAgent: boolean;
    /** Full path to the agent's .md file */
    agentFilePath: string;
}
/**
 * Error thrown when an agent file cannot be found.
 * Provides actionable error message per RULE-005.
 */
export declare class AgentFileNotFoundError extends Error {
    readonly agentKey: string;
    readonly filePath: string;
    readonly agentsDirectory: string;
    constructor(agentKey: string, filePath: string, agentsDirectory: string);
}
/**
 * Error thrown when prompt building fails.
 * Wraps underlying error with context per RULE-005.
 */
export declare class PromptBuildError extends Error {
    readonly agentKey: string;
    readonly phase: number;
    readonly cause: Error;
    constructor(agentKey: string, phase: number, cause: Error);
}
/**
 * Get the next agent to execute in the PhD Pipeline.
 * Implements RULE-015: Sequential execution - only returns next agent in sequence.
 *
 * @param session - Current pipeline session with state
 * @param options - Optional configuration for verbose logging
 * @returns NextAgentResult with agent config and prompt, or null if pipeline complete
 *
 * @throws {AgentFileNotFoundError} If agent .md file doesn't exist (RULE-005)
 * @throws {PromptBuildError} If prompt building fails (RULE-005)
 *
 * Pipeline Completion:
 * - Returns null when session.currentAgentIndex >= PHD_AGENTS.length (46)
 * - This indicates Phase 7 is complete and Phase 8 finalization should begin
 *
 * @example
 * const result = await getNextAgent(session, { verbose: true });
 * if (result === null) {
 *   console.log('Pipeline complete - proceed to Phase 8');
 * } else {
 *   console.log(`Next agent: ${result.agent.displayName}`);
 *   console.log(`Prompt length: ${result.prompt.length} chars`);
 * }
 */
declare function getNextAgent(session: IPhdSession, options?: {
    verbose?: boolean;
}): Promise<NextAgentResult | null>;
/**
 * Phase progress information returned by getPhaseProgress
 */
interface PhaseProgress {
    /** Number of agents completed in this phase */
    completed: number;
    /** Total number of agents in this phase */
    total: number;
    /** Percentage complete (0-100) */
    percentage: number;
    /** Array of completed agent keys in this phase */
    completedAgents: string[];
    /** Array of remaining agent keys in this phase */
    remainingAgents: string[];
}
/**
 * Extended session interface for phase-aware operations
 * Mirrors PipelineSession but typed for phase validation functions
 */
interface IPhdSession {
    sessionId: string;
    currentPhase: number;
    currentAgentIndex: number;
    completedAgents: string[];
    dynamicPhase6Agents?: Array<{
        key: string;
        phase: number;
    }>;
    dynamicTotalAgents?: number;
}
/**
 * Validate phase transition is allowed
 * Implements RULE-022: Phase N must complete before Phase N+1 begins
 *
 * @param currentPhase - Current phase number (1-7)
 * @param nextPhase - Target phase number to transition to
 * @returns true if transition is valid, false otherwise
 *
 * Valid transitions:
 * - Same phase (currentPhase === nextPhase): always allowed
 * - Next phase (nextPhase === currentPhase + 1): allowed (will be validated by isPhaseComplete)
 * - Skip phases (nextPhase > currentPhase + 1): NOT allowed (violates RULE-022)
 * - Previous phases (nextPhase < currentPhase): NOT allowed (no backward transitions)
 */
declare function validatePhaseTransition(currentPhase: number, nextPhase: number): boolean;
/**
 * Check if all agents in a specific phase are complete
 * Implements RULE-022: Phase N must complete before Phase N+1 begins
 *
 * @param session - Pipeline session with completion state
 * @param phaseId - Phase number to check (1-7)
 * @returns true if all agents in the phase have completed
 */
declare function isPhaseComplete(session: IPhdSession, phaseId: number): boolean;
/**
 * Get agent configurations for the current phase of a session
 * Supports both static (Phases 1-5, 7) and dynamic (Phase 6) agents
 *
 * @param session - Pipeline session with current phase info
 * @returns Array of AgentConfig objects for the current phase
 */
declare function getCurrentPhaseAgents(session: IPhdSession): PhdAgentConfig[];
/**
 * Get detailed progress information for a specific phase
 * Shows completed vs remaining agents with percentage
 *
 * @param session - Pipeline session with completion state
 * @param phaseId - Phase number to get progress for (1-7)
 * @returns PhaseProgress object with completion details
 */
declare function getPhaseProgress(session: IPhdSession, phaseId: number): PhaseProgress;
/**
 * Get progress information for all phases
 * Returns array of phase progress for display in status command
 *
 * @param session - Pipeline session with completion state
 * @returns Array of PhaseProgress objects indexed by phase (0-6 for phases 1-7)
 */
declare function getAllPhaseProgress(session: IPhdSession): Array<{
    phaseId: number;
    phaseName: string;
    progress: PhaseProgress;
}>;
/**
 * Determine the phase for a given agent index
 * Handles both static and dynamic agent configurations
 *
 * @param agentIndex - 0-based agent index
 * @param session - Optional session for dynamic Phase 6 handling
 * @returns Phase number (1-7) for the agent
 */
declare function getPhaseForAgentIndex(agentIndex: number, session?: IPhdSession): number;
/**
 * Check if the session is ready for Phase 8 (final orchestration)
 * Phase 8 runs synthesis across all outputs after Phase 7 completion
 *
 * @param session - Pipeline session to check
 * @returns true if all Phase 1-7 agents are complete and Phase 8 can begin
 */
declare function isReadyForPhase8(session: IPhdSession): boolean;
/**
 * Get canonical agent configuration by key from PHD_AGENTS (46 agents)
 * This is the preferred lookup method for agent metadata
 * @param key - Agent key (e.g., 'self-ask-decomposer')
 * @returns PhdAgentConfig from the canonical 46-agent configuration, or undefined
 */
declare function getCanonicalAgentByKey(key: string): PhdAgentConfig | undefined;
/**
 * Get canonical agents for a specific phase from PHD_AGENTS (46 agents)
 * @param phaseId - Phase number (1-7)
 * @returns Array of PhdAgentConfig for the specified phase
 */
declare function getCanonicalAgentsByPhase(phaseId: number): readonly PhdAgentConfig[];
/**
 * Get index of an agent in the canonical PHD_AGENTS array (46 agents)
 * @param key - Agent key to look up
 * @returns 0-based index or -1 if not found
 */
declare function getCanonicalAgentIndex(key: string): number;
/**
 * Check if an agent key exists in the canonical PHD_AGENTS configuration
 * @param key - Agent key to validate
 * @returns true if the agent exists in the 46-agent configuration
 */
declare function isValidCanonicalAgent(key: string): boolean;
/**
 * Execute init command
 * [REQ-PIPE-001, REQ-PIPE-011, REQ-PIPE-020, REQ-PIPE-021, REQ-PIPE-023]
 * [RULE-018] Agent Key Validity - validates all agent files before session creation
 */
declare function commandInit(query: string, options: InitOptions, sessionBasePath?: string): Promise<InitResponse>;
/**
 * Determine which style profile to use
 * [REQ-PIPE-011]
 */
declare function determineStyleProfile(profileId?: string): Promise<string>;
/**
 * Load style profile by ID
 */
declare function loadStyleProfile(profileId: string): Promise<StoredStyleProfile>;
/**
 * Generate pipeline ID from query
 */
declare function generatePipelineId(query: string): string;
/**
 * Generate research folder slug from query
 */
declare function generateSlug(query: string): string;
/**
 * Execute next command
 * [REQ-PIPE-002]
 *
 * @param sessionId - Session ID to get next agent for
 * @param options - Command options
 * @param sessionBasePath - Optional base path for session storage (for testing)
 */
declare function commandNext(sessionId: string, options: NextOptions, sessionBasePath?: string): Promise<NextResponse>;
/**
 * Execute complete command
 * [REQ-PIPE-003, REQ-PIPE-024]
 *
 * @param sessionId - Session ID to update
 * @param agentKey - Agent key being completed
 * @param options - Command options
 * @param sessionBasePath - Optional base path for session storage (for testing)
 */
declare function commandComplete(sessionId: string, agentKey: string, options: CompleteOptions, sessionBasePath?: string): Promise<CompleteResponse>;
/**
 * Extended status response with phase-by-phase progress
 * TASK-CONFIG-003: Enhanced phase progress reporting
 */
interface ExtendedStatusResponse extends StatusResponse {
    /** Phase-by-phase progress breakdown (TASK-CONFIG-003) */
    phaseProgress?: Array<{
        phaseId: number;
        phaseName: string;
        progress: PhaseProgress;
        isComplete: boolean;
        isCurrent: boolean;
    }>;
    /** Remaining agents in current phase */
    remainingInCurrentPhase?: string[];
    /** Ready for Phase 8 finalization */
    readyForPhase8?: boolean;
}
/**
 * Execute status command
 * [REQ-PIPE-004]
 * TASK-CONFIG-003: Enhanced with phase-by-phase progress reporting
 *
 * @param sessionId - Session ID to get status for
 * @param options - Command options
 * @param sessionBasePath - Optional base path for session storage (for testing)
 */
declare function commandStatus(sessionId: string, options: StatusOptions, sessionBasePath?: string): Promise<ExtendedStatusResponse>;
/**
 * Execute list command
 * [REQ-PIPE-005]
 *
 * @param options - Command options
 * @param sessionBasePath - Optional base path for session storage (for testing)
 */
declare function commandList(options: ListOptions, sessionBasePath?: string): Promise<ListResponse>;
/**
 * Execute resume command
 * [REQ-PIPE-006]
 *
 * @param sessionId - Session ID to resume
 * @param options - Command options
 * @param sessionBasePath - Optional base path for session storage (for testing)
 */
declare function commandResume(sessionId: string, options: ResumeOptions, sessionBasePath?: string): Promise<ResumeResponse>;
/**
 * Execute abort command
 * [REQ-PIPE-007]
 *
 * @param sessionId - Session ID to abort
 * @param options - Command options
 * @param sessionBasePath - Optional base path for session storage (for testing)
 */
declare function commandAbort(sessionId: string, options: AbortOptions, sessionBasePath?: string): Promise<AbortResponse>;
/**
 * CLI options interface for finalize command
 */
interface FinalizeCliOptions {
    slug: string;
    force?: boolean;
    dryRun?: boolean;
    threshold?: string;
    verbose?: boolean;
    sequential?: boolean;
    skipValidation?: boolean;
    /** Generate synthesis prompts for Claude Code instead of writing chapters */
    generatePrompts?: boolean;
    /** Style profile ID to use (overrides session lookup) */
    styleProfile?: string;
    /** Generate PDF from existing synthesized chapters (skips prompt generation) */
    generatePdf?: boolean;
}
/**
 * Execute finalize command
 * [REQ-PIPE-008] Per SPEC-FUNC-001 Section 3.1
 *
 * Exit Codes per CONSTITUTION Appendix B:
 * 0 - SUCCESS: All phases completed successfully
 * 1 - GENERAL_ERROR: Unspecified error
 * 2 - MISSING_FILES: Required input files missing
 * 3 - TOKEN_OVERFLOW: Context limit exceeded
 * 4 - MAPPING_FAILURE: Chapter with zero sources
 * 5 - VALIDATION_FAILURE: Output quality validation failed
 * 6 - SECURITY_VIOLATION: SE-xxx rule violated
 * 7 - CONSTITUTION_VIOLATION: Critical DI-xxx or FS-xxx rule violated
 *
 * @param cliOptions - Command line options
 * @returns FinalStageResult with output details
 */
declare function commandFinalize(cliOptions: FinalizeCliOptions): Promise<FinalStageResult>;
export { commandInit, commandNext, commandComplete, commandStatus, commandList, commandResume, commandAbort, commandFinalize, determineStyleProfile, loadStyleProfile, generatePipelineId, generateSlug, PHD_PIPELINE_AGENT_COUNT, getCanonicalAgentByKey, getCanonicalAgentsByPhase, getCanonicalAgentIndex, isValidCanonicalAgent, validatePhaseTransition, isPhaseComplete, getCurrentPhaseAgents, getPhaseProgress, getAllPhaseProgress, getPhaseForAgentIndex, isReadyForPhase8, validateAgentFiles, getNextAgent, };
export type { PhaseProgress, IPhdSession, ExtendedStatusResponse };
export { PHD_AGENTS, PHD_PHASES, DEFAULT_CONFIG, } from './phd-pipeline-config.js';
//# sourceMappingURL=phd-cli.d.ts.map